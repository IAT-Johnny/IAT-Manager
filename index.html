<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Agendamento de Prova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--fg:#111;--muted:#666;--pri:#1a73e8}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;padding:16px 18px;box-shadow:0 12px 32px rgba(20,20,20,.06)}
    h1{font-size:28px;margin:6px 0 16px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-size:13px;margin-top:10px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d9dbe0;border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:80px;resize:vertical}
    button{background:var(--pri);color:#fff;border:0;padding:10px 16px;border-radius:12px;cursor:pointer}
    .ok{color:#137333}.err{color:#b00020}
    img{border-radius:50%}
    .sp{height:10px}
    pre{white-space:pre-wrap;background:#0f1115;color:#dfe1e5;padding:10px;border-radius:10px;font-size:12px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0}
    #admin{border:1px dashed #cbd5e1;background:#fbfdff}
    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #d9dbe0;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Agendamento de Prova</h1>

  <!-- LOGIN -->
  <div id="auth" class="card">
    <div id="g_id_onload"
         data-client_id="826003708445-8612nadjq2l7ahb4ht0bpq47csp1rbpb.apps.googleusercontent.com"
         data-callback="onCred"
         data-auto_prompt="false"></div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-shape="pill"></div>
    <div class="sp"></div>
    <div class="muted">Entre com um e-mail cadastrado na Config.</div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="inline">
      <img id="foto" width="48" height="48" alt="">
      <div>
        <div id="boas"></div>
        <div class="muted" id="info"></div>
      </div>
      <div style="flex:1"></div>
      <button id="btnPing" type="button">Testar backend (ping)</button>
    </div>

    <!-- Estabelecimento / Estande -->
    <div class="sp"></div>
    <div id="estBox" class="inline">
      <label style="margin:0">Estande:</label>
      <!-- Para n√£o-admin ficar√° somente texto; para admin vira input edit√°vel -->
      <input id="estSel" placeholder="Estande" style="max-width:280px;display:none">
      <span id="estTxt" class="pill"></span>
    </div>

    <!-- PAINEL ADMIN (autoriza√ß√µes) -->
    <div id="admin" class="card" style="display:none;margin-top:14px">
      <h3>Painel Admin</h3>

      <h4>Disponibilidade (pontual)</h4>
      <div class="row">
        <div>
          <label>Estande</label><input id="adEst" placeholder="ex.: WestGun">
          <label>Data</label><input id="adData" type="date">
        </div>
        <div>
          <label>Hor√°rio (HH:mm)</label><input id="adHora" placeholder="18:30">
          <label>Somente para este e-mail (opcional)</label><input id="adUser" placeholder="usuario@dominio.com">
        </div>
      </div>
      <div class="sp"></div>
      <div class="inline">
        <button id="btnAddDisp" type="button">Autorizar</button>
      </div>

      <div class="sp"></div><hr/><div class="sp"></div>

      <h4>Regra recorrente (ex.: TER 18:30)</h4>
      <div class="row-3">
        <div>
          <label>Alvo</label>
          <select id="rgTarget">
            <option value="all">Todos</option>
            <option value="user">Usu√°rio</option>
            <option value="estande">Estande</option>
          </select>
          <label>Valor (e-mail ou estande)</label><input id="rgValue" placeholder="multi3@gmail.com ou WestGun">
        </div>
        <div>
          <label>Dia da semana</label>
          <select id="rgWeekday">
            <option value="SEG">Segunda</option><option value="TER">Ter√ßa</option>
            <option value="QUA">Quarta</option><option value="QUI">Quinta</option>
            <option value="SEX">Sexta</option><option value="SAB">S√°bado</option>
            <option value="DOM">Domingo</option>
          </select>
          <label>Hor√°rio (HH:mm)</label><input id="rgHora" placeholder="18:30">
        </div>
        <div>
          <label>In√≠cio (opcional)</label><input id="rgIni" type="date">
          <label>Fim (opcional)</label><input id="rgFim" type="date">
        </div>
      </div>
      <div class="sp"></div>
      <div class="inline">
        <button id="btnAddRegra" type="button">Adicionar regra</button>
      </div>
    </div>

    <div class="sp"></div><hr/><div class="sp"></div>

    <!-- FORMUL√ÅRIO DE AGENDAMENTO -->
    <form id="frm">
      <div class="row">
        <div>
          <label>Nome do atirador</label>
          <input id="nome" required>
        </div>
        <div>
          <label>CPF</label>
          <input id="cpf" required inputmode="numeric" maxlength="14" placeholder="000.000.000-00">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Telefone</label>
          <input id="tel" required placeholder="(00) 90000-0000" maxlength="16">
        </div>
        <div>
          <label>CEP</label>
          <input id="cep" required inputmode="numeric" maxlength="9" placeholder="00000-000">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Logradouro</label>
          <input id="logr" required>
        </div>
        <div>
          <label>N√∫mero</label>
          <input id="num" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Complemento</label>
          <input id="comp">
        </div>
        <div>
          <label>Bairro</label>
          <input id="bairro" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cidade</label>
          <input id="cidade" required>
        </div>
        <div>
          <label>UF</label>
          <input id="uf" required maxlength="2">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Data</label>
          <input id="data" type="date" required>
        </div>
        <div>
          <label>Hor√°rio</label>
          <select id="horario" required></select>
          <small class="muted" id="slotsHint"></small>
        </div>
      </div>

      <!-- ESP√âCIES (sempre vis√≠vel) -->
      <div>
        <label>Esp√©cie(s) de arma</label>
        <div id="espList" class="inline"></div>
        <small class="muted">Se nenhuma arma for digitada abaixo, usaremos a arma padr√£o de cada esp√©cie selecionada.</small>
      </div>

      <!-- Opcional: admin pode escrever armas espec√≠ficas -->
      <div id="armasAdminBox" style="display:none">
        <label>Armas (opcional, admin pode sobrescrever)</label>
        <input id="armasTxt" placeholder="ex.: TS9; G25; RT889">
      </div>

      <label>Observa√ß√µes</label>
      <textarea id="obs" placeholder="Escreva aqui..."></textarea>

      <div class="sp"></div>
      <button type="submit">Enviar agendamento</button>
      <span id="msg" class="muted"></span>
    </form>

    <div class="sp"></div><hr/><div class="sp"></div>
    <div class="muted">Log</div>
    <pre id="log"></pre>
  </div>
</div>

<script>
/*** CONFIG ***/
const GAS_URL   = 'https://script.google.com/macros/s/AKfycbwrYWQ3gVE3wSobk3w049hva6R5wmN9WayxuUh9itl1qvOQVaHXF9_JxEmgSQ9YMliy/exec';
const CLIENT_ID = '826003708445-8612nadjq2l7ahb4ht0bpq47csp1rbpb.apps.googleusercontent.com';

/*** JSONP helper ***/
function callJSONP(params, timeoutMs=20000){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const url = GAS_URL + (GAS_URL.includes('?')?'&':'?') +
      Object.entries(params).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&') +
      '&callback=' + encodeURIComponent(cb) + '&t=' + Date.now();
    log('JSONP URL: ' + url);
    const s = document.createElement('script'); s.async = true; s.referrerPolicy='no-referrer';
    let done=false;
    function cleanup(){ try{delete window[cb]}catch{}; s.remove(); }
    window[cb] = (data)=>{ done=true; cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error('erro de script JSONP')); };
    s.src = url; document.body.appendChild(s);
    setTimeout(()=>{ if(!done){ cleanup(); reject(new Error('timeout')); } }, timeoutMs);
  });
}

/*** UI helpers ***/
const $ = sel => document.querySelector(sel);
function log(t){ const el=$('#log'); el.textContent += (t+'\n'); el.scrollTop = el.scrollHeight; }
function setMsg(t,ok){ const el=$('#msg'); el.textContent=t||''; el.className = ok?'ok':'err'; }

/*** M√°scaras & CEP ***/
function maskCPF(v){ v=v.replace(/\D/g,'').slice(0,11); return v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2'); }
function maskTEL(v){ v=v.replace(/\D/g,'').slice(0,11); return v.replace(/^(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d{4})$/,'$1-$2'); }
function maskCEP(v){ v=v.replace(/\D/g,'').slice(0,8); return v.replace(/(\d{5})(\d{1,3})$/,'$1-$2'); }
function cpfOk(cpf){
  cpf = (cpf||'').replace(/\D/g,''); if (!cpf||cpf.length!==11||/^(\d)\1+$/.test(cpf)) return false;
  let s=0; for(let i=0;i<9;i++) s+=parseInt(cpf[i])*(10-i); let d=11-(s%11); if(d>9)d=0; if(d!=cpf[9]) return false;
  s=0; for(let i=0;i<10;i++) s+=parseInt(cpf[i])*(11-i); d=11-(s%11); if(d>9)d=0; return d==cpf[10];
}
async function buscaCEP(cep){
  cep = (cep||'').replace(/\D/g,'');
  if (cep.length!==8) return;
  try{
    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const j = await r.json();
    if (j.erro){ setMsg('CEP n√£o encontrado',false); return; }
    $('#logr').value   = j.logradouro || '';
    $('#bairro').value = j.bairro     || '';
    $('#cidade').value = j.localidade || '';
    $('#uf').value     = j.uf         || '';
    setMsg('',true);
  }catch(e){ setMsg('Erro no ViaCEP',false); }
}

/*** Estado global ***/
let session = null;
let profile = null;
let isAdmin = false;
let estandeAtual = '';
let especiesDisponiveis = [];

/*** Login callback ***/
async function onCred(res){
  try{
    log('onCred chamado. cred len = '+ (res.credential||'').length);
    const who = await callJSONP({op:'whoami', idToken: res.credential});
    if (!who.ok){ setMsg('Falha no login: '+(who.error||''), false); return; }

    session = who.session;
    profile = {email: who.email, name: who.name, picture: who.picture};
    isAdmin = !!who.admin;
    estandeAtual = who.estande || '';

    $('#auth').style.display='none';
    $('#app').style.display='block';

    $('#boas').textContent = `Ol√°, ${who.name}! üéâ`;
    $('#info').textContent = `${who.email}`;
    $('#foto').src = who.picture || '';
    $('#nome').value = who.name || '';

    // estande UI
    if (isAdmin){
      $('#estTxt').style.display='none';
      $('#estSel').style.display='inline-block';
      $('#estSel').value = estandeAtual;
      $('#armasAdminBox').style.display='block';
      $('#admin').style.display='block';
      $('#adEst').value = estandeAtual;
    }else{
      $('#estSel').style.display='none';
      $('#estTxt').textContent = estandeAtual || '(sem estande)';
      $('#estTxt').style.display='inline-flex';
      $('#armasAdminBox').style.display='none';
      $('#admin').style.display='none';
    }

    // carregar listas b√°sicas (especies e horarios base)
    const lst = await callJSONP({op:'listar', session});
    if (!lst.ok){ setMsg('Erro ao carregar listas: '+(lst.error||''), false); return; }

    especiesDisponiveis = lst.especies || [];
    renderEspecies(especiesDisponiveis);

    // preenche hor√°rios conforme data (usando rota /slots)
    $('#data').value = ''; // usu√°rio escolhe
    $('#horario').innerHTML = '';
    $('#slotsHint').textContent = 'Escolha uma data para carregar os hor√°rios';

    setMsg('',true);
  }catch(e){
    setMsg('Erro de autentica√ß√£o: '+e, false);
  }
}

/*** Render de esp√©cies (checkbox) ***/
function renderEspecies(list){
  const box = $('#espList'); box.innerHTML = '';
  list.forEach(esp=>{
    const id = 'esp_' + esp.replace(/\s+/g,'_');
    const label = document.createElement('label');
    label.className='pill'; label.htmlFor = id;
    label.innerHTML = `<input type="checkbox" id="${id}" value="${esp}"> ${esp}`;
    box.appendChild(label);
  });
}

/*** Eventos UI ***/
$('#btnPing').onclick = async ()=>{
  try{
    const r = await callJSONP({op:'ping'});
    setMsg('Backend OK: '+ r.ts, true);
  }catch(e){ setMsg('Erro no backend: '+e.message, false); }
};

$('#cep').addEventListener('input', e => e.target.value = maskCEP(e.target.value));
$('#cep').addEventListener('blur',  e => buscaCEP(e.target.value));
$('#cpf').addEventListener('input', e => e.target.value = maskCPF(e.target.value));
$('#tel').addEventListener('input', e => e.target.value = maskTEL(e.target.value));

function getEstandeAtual(){
  return isAdmin ? ($('#estSel').value || estandeAtual) : estandeAtual;
}

// quando mudar data ou (se admin) o estande, pedir os hor√°rios v√°lidos
$('#data').addEventListener('change', loadSlots);
$('#estSel').addEventListener('input', ()=>{ if($('#data').value) loadSlots(); });

async function loadSlots(){
  const d = $('#data').value; // yyyy-mm-dd
  const est = getEstandeAtual();
  if (!d || !est) return;
  try{
    const r = await callJSONP({op:'slots', session, date:d, estande:est});
    if (!r.ok){ setMsg('Erro slots: '+(r.error||''), false); return; }
    const h = $('#horario'); h.innerHTML='';
    (r.slots||[]).forEach(x=>{
      const o=document.createElement('option'); o.value=o.textContent=x; h.appendChild(o);
    });
    $('#slotsHint').textContent = r.slots?.length ? `${r.slots.length} hor√°rio(s) dispon√≠veis` : 'Sem hor√°rios autorizados';
  }catch(e){ setMsg('Erro slots: '+e.message,false); }
}

/*** Submit ***/
$('#frm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  setMsg('Enviando...', true);

  // esp√©cies selecionadas
  const espSel = Array.from(document.querySelectorAll('#espList input[type=checkbox]:checked'))
    .map(x=>x.value).join(', ');

  const payload = {
    op:'submit',
    session,
    // quem agenda pode editar o nome
    nome_atirador: $('#nome').value.trim(),
    cpf: $('#cpf').value,
    telefone: $('#tel').value,
    cep: $('#cep').value,
    logradouro: $('#logr').value,
    numero: $('#num').value,
    complemento: $('#comp').value,
    bairro: $('#bairro').value,
    cidade: $('#cidade').value,
    uf: $('#uf').value,
    data: $('#data').value,            // yyyy-mm-dd
    horario: $('#horario').value,
    especies: espSel,
    armas_escolhidas: isAdmin ? $('#armasTxt').value.trim() : '',
    obs: $('#obs').value
  };

  if (!payload.nome_atirador){ setMsg('Informe o nome do atirador.', false); return; }
  if (!cpfOk(payload.cpf)){ setMsg('CPF inv√°lido', false); return; }
  if (!payload.data || !payload.horario){ setMsg('Informe data e hor√°rio.', false); return; }

  try{
    const r = await callJSONP(payload);
    if (!r.ok){ setMsg('Erro: '+(r.error||'falha'), false); return; }
    setMsg(r.message || 'Agendado!', true);
    log(JSON.stringify(r, null, 2));
    $('#frm').reset();
    $('#slotsHint').textContent = '';
  }catch(e){ setMsg('Erro ao enviar: '+e.message, false); }
});

/*** ADMIN ACTIONS ***/
$('#btnAddDisp').onclick = async ()=>{
  try{
    const est = $('#adEst').value.trim() || getEstandeAtual();
    const d   = $('#adData').value;
    const h   = $('#adHora').value.trim();
    const usr = $('#adUser').value.trim();
    if (!est || !d || !h){ alert('Preencha estande, data e hor√°rio.'); return; }
    const r = await callJSONP({op:'admin_disp_add', session, estande:est, data:d, horario:h, user_email:usr});
    if (r.ok){ setMsg('Disponibilidade registrada', true); if($('#data').value===d) loadSlots(); }
    else setMsg('Admin: '+(r.error||'falha'), false);
  }catch(e){ setMsg('Admin: '+e.message,false); }
};

$('#btnAddRegra').onclick = async ()=>{
  try{
    const tt = $('#rgTarget').value;
    const tv = $('#rgValue').value.trim() || (tt==='estande' ? getEstandeAtual() : '');
    const wd = $('#rgWeekday').value;
    const hr = $('#rgHora').value.trim();
    const sd = $('#rgIni').value.trim();
    const ed = $('#rgFim').value.trim();
    if (!tt || !wd || !hr || (tt!=='all' && !tv)){ alert('Preencha os campos obrigat√≥rios.'); return; }
    const r = await callJSONP({op:'admin_regra_add', session, target_type:tt, target_value:tv, weekday:wd, horario:hr, start_date:sd, end_date:ed});
    if (r.ok){ setMsg('Regra adicionada', true); if($('#data').value) loadSlots(); }
    else setMsg('Admin: '+(r.error||'falha'), false);
  }catch(e){ setMsg('Admin: '+e.message,false); }
};
</script>
</body>
</html>
